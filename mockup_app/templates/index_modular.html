<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GlareCheck.com</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/logos/favicon.ico">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary-blue: #4274a5;
            --accent-yellow: #ffc107;
            --text-primary: #333333;
            --text-secondary: #666666;
            --background-light: #f8fafc;
            --border-color: #e2e8f0;
            --header-height: 72px; /* 70px header + 2px border */
            --sidebar-width: 380px;
        }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--background-light);
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        /* Header */
        .header {
            height: 70px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 25px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
        }
        
        .header h1 {
            font-size: 1.5rem;
            margin: 0;
            color: var(--primary-blue);
            font-weight: 600;
        }
        
        /* Layout Container */
        .main-container {
            display: flex;
            height: calc(100vh - 70px);
            margin-top: 70px;
        }
        
        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            overflow-x: hidden;
            flex-shrink: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* Map Container */
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        /* Coordinate Display */
        .coordinate-display {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 12px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            z-index: 100;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            pointer-events: none;
            user-select: none;
        }
        
        .coordinate-display .coord-label {
            color: #666;
            font-weight: 600;
            margin-right: 5px;
        }
        
        .coordinate-display .coord-value {
            color: #333;
        }
        
        
        /* Menu Styles with Animations */
        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            color: var(--text-primary);
            opacity: 1;
            transform: translateX(0);
        }
        
        .menu-item:hover {
            background-color: var(--background-light);
        }
        
        .menu-item.active {
            background-color: #e3f2fd;
            color: var(--primary-blue);
            font-weight: 500;
        }
        
        .menu-item i {
            width: 20px;
            margin-right: 12px;
            font-size: 1.1rem;
        }
        
        .menu-section {
            padding: 0;
            background: white;
            overflow-y: auto;
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1),
                        opacity 0.3s ease;
            transform: translateX(0);
            opacity: 1;
        }
        
        /* Hide menu when submenu is active */
        .menu-section.collapsed {
            display: none;
        }
        
        /* Back button - simpler design */
        .content-panel .back-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 18px;
            margin: 15px 20px 20px 20px;
            background: transparent;
            color: #64748b;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 0.9rem;
            font-weight: 500;
            width: calc(100% - 40px);
        }
        
        .content-panel .back-button:hover {
            background: #f8fafc;
            color: #475569;
            transform: translateX(-2px);
            border-color: #cbd5e1;
        }
        
        .content-panel .back-button i {
            font-size: 1.1rem;
            transition: transform 0.2s ease;
        }
        
        .content-panel .back-button:hover i {
            transform: translateX(-4px);
        }
        
        .content-panel .back-button .button-text {
            display: inline;
        }
        
        /* Current function display removed as requested */
        
        /* All menu headers - consistent style */
        .menu-header {
            padding: 20px 25px;
            margin: 0;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 2px solid var(--primary-blue);
            color: var(--primary-blue);
            font-size: 1.25rem;
            font-weight: 600;
            letter-spacing: -0.5px;
        }
        
        /* Make submenu headers full width */
        .content-panel .menu-header {
            margin-left: 0;
            margin-right: 0;
            width: 100%;
        }
        
        
        /* Search Box */
        .search-box {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary-blue);
        }
        
        /* Content Panels with Slide Animation */
        .content-panel {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 0;
            overflow: hidden; /* Changed from auto to hidden */
            background: white;
            z-index: 10;
            flex-direction: column;
        }
        
        .content-panel.active {
            display: flex; /* Changed from block to flex */
            animation: slideInFromLeft 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        
        .content-panel.sliding-out {
            display: block;
            animation: slideOutToLeft 0.3s cubic-bezier(0.4, 0.0, 0.2, 1) forwards;
            pointer-events: none;
        }
        
        @keyframes slideInFromLeft {
            from {
                transform: translateX(-100%);
                opacity: 0.5;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutToLeft {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(-100%);
                opacity: 0;
            }
        }
        
        /* Special case for default hint - just fade */
        #default-hint {
            animation: none;
        }
        
        #default-hint.active {
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Lists */
        .element-list {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 2px 5px 20px 5px; /* Small top padding to prevent cutoff */
            min-height: 0; /* Important for flexbox scrolling */
        }
        
        /* Wrapper for scrollable content in panels */
        .scrollable-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }
        
        /* Small form checks */
        .form-check-sm .form-check-input {
            width: 0.875rem;
            height: 0.875rem;
            margin-top: 0.25rem;
            border-color: #cbd5e0;
        }
        
        .form-check-sm .form-check-input:checked {
            background-color: #4274a5;
            border-color: #4274a5;
        }
        
        .form-check-sm .form-check-label {
            font-size: 0.75rem;
            color: #64748b;
        }
        
        /* Auto-calculate styling - remove all styling */
        .pv-details input[type="checkbox"] {
            margin: 0 4px 0 4px;
            border: 1px solid #cbd5e0;
            background: white;
        }
        
        .pv-details input[type="checkbox"]:checked {
            background-color: #4274a5;
            border-color: #4274a5;
        }
        
        .pv-details label[for*="auto-calc"] {
            font-size: 0.75rem;
            color: #64748b;
            margin: 0;
            background: none !important;
            border: none !important;
            padding: 0 !important;
            display: inline !important;
        }
        
        
        .element-item {
            padding: 12px 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }
        
        .element-item:hover {
            background-color: #f8fafc;
            box-shadow: 0 2px 6px rgba(66, 116, 165, 0.15);
            transform: translateY(-1px);
        }
        
        .pv-area-item .element-item {
            transition: background-color 0.2s;
        }
        
        .pv-area-item .element-item:hover {
            background-color: #f0f4f8;
        }
        
        /* PV Details Styling */
        .pv-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background: transparent;
            margin: 0;
            padding: 0;
        }
        
        .pv-details.expanded {
            max-height: 1500px;
            transition: max-height 0.5s ease-in;
            margin-top: 0; /* Reset margin */
        }
        
        .pv-details .small {
            background: white;
            border: 1px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            padding: 15px;
            margin: 0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.03);
        }
        
        /* Blue border for expanded items with overlap */
        .pv-details.expanded .small {
            border-color: #4274a5;
            border-top: 1px solid #4274a5; /* Add blue top border */
            margin-top: -2px; /* Overlap with header */
            position: relative;
            z-index: 1;
        }
        
        .pv-details .row {
            margin-bottom: 12px;
        }
        
        .pv-details .col-form-label {
            color: #64748b;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .pv-details .btn-group {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
        }
        
        /* PV area item header styling */
        .pv-area-item {
            margin-bottom: 8px; /* Reduced spacing between items */
        }
        
        .pv-area-item .element-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px 15px;
            transition: all 0.2s ease;
            position: relative;
            z-index: 2;
        }
        
        .pv-area-item .element-item:hover {
            background: #f8fafc;
            border-color: #4274a5;
            box-shadow: 0 2px 6px rgba(66, 116, 165, 0.1);
            position: relative; /* Ensure proper stacking */
            z-index: 2; /* Bring to front on hover */
        }
        
        /* When expanded, connect header with details */
        .pv-area-item:has(.pv-details.expanded) .element-item {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom-color: #4274a5; /* Keep border but make it blue */
            background: #4274a5;
            color: white;
            border-color: #4274a5;
            margin-bottom: -1px; /* Pull content up by overlapping */
        }
        
        .pv-area-item:has(.pv-details.expanded) .element-item .text-muted {
            color: rgba(255, 255, 255, 0.7) !important;
        }
        
        .pv-area-item:has(.pv-details.expanded) .element-item .text-danger {
            color: rgba(255, 182, 193, 0.9) !important;
        }
        
        /* Remove padding and margins for seamless connection */
        .pv-details.expanded + .pv-details .small {
            margin-top: -1px;
        }
        
        /* Buttons */
        .btn-sm {
            padding: 6px 14px;
            font-size: 0.875rem;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: #4274a5;
            border: none;
        }
        
        .btn-primary:hover {
            background: #5a86c7;
        }
        
        /* Create button style - simple prominent */
        .btn-create {
            background: #4274a5;
            color: white;
            border: none;
            padding: 12px 18px;
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 6px;
            transition: background 0.2s ease;
            margin: 0 20px 20px 20px;
            width: calc(100% - 40px) !important;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-create:hover {
            background: #5a86c7;
        }
        
        /* Separator line after buttons */
        .btn-create:last-of-type {
            padding-bottom: 14px;
            margin-bottom: 20px;
            position: relative;
        }
        
        .btn-create:last-of-type::after {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #cbd5e1 15%, #cbd5e1 85%, transparent);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        
        .btn-create i {
            font-size: 1rem;
        }
        
        .btn-outline-primary {
            color: #4274a5;
            border: 1px solid #4274a5;
            background: white;
        }
        
        .btn-outline-primary:hover {
            background: #4274a5;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(66, 116, 165, 0.2);
        }
        
        /* Fix for PV type modal hover text */
        #pvTypeModal .btn-outline-primary:hover small {
            color: rgba(255, 255, 255, 0.9) !important;
        }
        
        #pvTypeModal .btn-outline-primary small {
            transition: color 0.15s ease;
        }
        
        .btn-delete {
            color: #dc3545;
            background: none;
            border: none;
            cursor: pointer;
        }
        
        .btn-delete:hover {
            color: #a02622;
        }
        
        /* Info tooltips styling */
        .info-tooltip {
            color: #4274a5;
            font-size: 0.9rem;
            cursor: help;
            margin-left: 5px;
        }
        
        .info-tooltip:hover {
            color: #5a86c7;
        }
        
        /* Content sections padding */
        .content-section {
            padding: 20px;
        }
        
        .content-section h5 {
            color: #4274a5;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        /* Section headings in subpanels (not menu headers) */
        .content-panel h6:not(.menu-header) {
            color: #475569;
            font-size: 0.95rem;
            font-weight: 600;
            margin: 35px 20px 10px 20px;
            padding: 0;
        }
        
        /* First section heading after buttons */
        .btn-create:last-of-type ~ h6:first-of-type {
            margin-top: 45px;
        }
        
        /* Panel content wrapper for consistent spacing */
        .panel-content {
            padding: 20px;
        }
        
        .panel-content > *:first-child {
            margin-top: 0;
        }
        
        .panel-content > *:last-child {
            margin-bottom: 0;
        }
        
        /* Ensure consistent spacing between panel elements */
        .content-panel > *:not(.menu-header) {
            margin-left: 20px;
            margin-right: 20px;
        }
        
        .content-panel > .back-button {
            margin: 15px 20px 20px 20px;
        }
        
        .content-panel > .element-list {
            margin: 0;
            padding: 20px;
        }
        
        /* Drag and Drop styles */
        .pv-area-item {
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }
        
        .pv-area-item.dragging {
            opacity: 0.4;
            transform: scale(0.95);
            background-color: #f0f0f0;
        }
        
        .pv-area-item.drag-over-top {
            border-top: 3px solid #4274a5;
            padding-top: 8px;
            margin-top: -5px;
        }
        
        .pv-area-item.drag-over-bottom {
            border-bottom: 3px solid #4274a5;
            padding-bottom: 8px;
            margin-bottom: -5px;
        }
        
        .pv-area-item .fa-grip-vertical {
            transition: all 0.2s ease;
        }
        
        .pv-area-item .fa-grip-vertical:hover {
            color: #4274a5 !important;
            transform: scale(1.2);
        }
        
        .pv-area-item .fa-grip-vertical:active {
            cursor: grabbing !important;
        }
        
        @keyframes pulse {
            0% {
                background-color: rgba(66, 116, 165, 0.1);
            }
            50% {
                background-color: rgba(66, 116, 165, 0.3);
            }
            100% {
                background-color: rgba(66, 116, 165, 0.1);
            }
        }
        
        /* Module Type Manager Styles */
        #moduleTypesList .table {
            margin-bottom: 0;
        }
        
        #moduleTypesList .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border-color);
        }
        
        #moduleTypesList .table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        #moduleTypesList .badge {
            font-size: 0.75rem;
        }
        
        #moduleTypesList .btn-group-sm .btn {
            padding: 0.125rem 0.5rem;
        }
        
        /* Module Type Cards */
        #moduleTypesList .card {
            border: 1px solid #dee2e6;
            transition: box-shadow 0.2s;
        }
        
        #moduleTypesList .card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        #moduleTypesList .btn-sm {
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
        }
        
        #moduleTypesList .badge {
            padding: 0.35em 0.65em;
        }
        
        /* Delete Modal Styling */
        .modal-header.bg-danger {
            background-color: #dc3545 !important;
        }
        
        .btn-close-white {
            filter: invert(1) grayscale(100%) brightness(200%);
        }
        
        /* Topography Panel Styles */
        .topo-panel-content {
            overflow-y: auto;
            max-height: calc(100vh - 200px);
            margin-left: 0 !important;
            margin-right: 0 !important;
            padding: 0 20px 20px 20px;
        }

        .topo-option-card {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
            background: white;
            margin-bottom: 12px;
        }

        .topo-option-card:hover {
            border-color: var(--primary-blue);
            background: #f8fafc;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .topo-option-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 6px 0;
        }

        .topo-option-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin: 0;
            line-height: 1.4;
        }

        /* Drag & Drop Zone */
        .topo-drop-zone {
            border: 3px dashed #cbd5e1;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            background: #f8fafc;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .topo-drop-zone:hover {
            border-color: var(--primary-blue);
            background: #eff6ff;
        }

        .topo-drop-zone.drag-over {
            border-color: var(--primary-blue);
            background: #dbeafe;
            border-style: solid;
        }

        .topo-drop-zone i {
            transition: transform 0.2s ease;
        }

        .topo-drop-zone:hover i {
            transform: translateY(-5px);
        }

        /* Corner Details Panel */
        .corner-details-panel {
            position: fixed;
            top: 70px; /* Align exactly with header bottom to avoid any gap */
            right: -650px;
            width: 650px;
            height: calc(100vh - 70px);
            background: white;
            border-left: 1px solid var(--border-color);
            z-index: 999;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        .corner-details-panel.open {
            right: 0;
        }
        
        .corner-details-panel .panel-header-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .corner-details-panel .menu-header {
            margin: 0;
            width: 100%;
            /* Inherit all styles from global .menu-header */
        }
        
        .corner-details-panel .panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            padding-bottom: 10px; /* Reduce bottom padding since we have footer */
        }

        .corner-details-panel .panel-footer {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        .corners-container {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        /* Form Controls Styling */
        .form-control {
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            background: white;
        }
        
        .form-control:focus {
            border-color: #4274a5;
            box-shadow: 0 0 0 3px rgba(66, 116, 165, 0.1);
            outline: none;
        }
        
        .form-control-sm {
            padding: 6px 10px;
            font-size: 0.85rem;
        }
        
        .form-label {
            color: #475569;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 6px;
        }
        
        /* Form groups in panels */
        .content-panel .form-group,
        .content-panel .mb-3 {
            margin-bottom: 15px;
        }
        
        .content-panel .form-group:last-child,
        .content-panel .mb-3:last-child {
            margin-bottom: 0;
        }
        
        .input-group {
            position: relative;
        }
        
        .input-group-text {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            color: #64748b;
            font-size: 0.85rem;
        }
        
        .coordinate-input-group {
            position: relative;
        }
        
        .coordinate-input-group .form-control:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 0.2rem rgba(66, 116, 165, 0.25);
        }
        
        .coordinate-edit-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        .corner-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }
        
        .corner-card.editing {
            background: #fff3cd;
            border-color: #ffc107;
        }
        
        .coordinate-info {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        /* Corner label with outline for better readability */
        .corner-label-with-outline {
            text-shadow: 
                -1px -1px 0 #000,
                 1px -1px 0 #000,
                -1px  1px 0 #000,
                 1px  1px 0 #000,
                -1px  0   0 #000,
                 1px  0   0 #000,
                 0   -1px 0 #000,
                 0    1px 0 #000;
        }
        
        /* Custom checkbox styling */
        .form-check-input:checked {
            background-color: #4274a5;
            border-color: #4274a5;
        }
        
        .form-check-input:focus {
            border-color: #4274a5;
            box-shadow: 0 0 0 0.25rem rgba(66, 116, 165, 0.25);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header" style="display: flex; align-items: center; justify-content: space-between; padding: 10px 20px;">
        <div style="display: flex; align-items: center;">
            <img src="/logos/GlearCheck_Logo_5.png" alt="GlareCheck Logo" style="height: 40px; margin-right: 15px;">
            <h1 style="margin: 0;">GlareCheck.com</h1>
        </div>
        <div id="languageSwitcherContainer"></div>
    </header>
    
    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Menu -->
            <div class="menu-section" id="menu-section">
                <h6 class="menu-header" data-i18n="menu.main">Hauptmenü</h6>
                <button class="menu-item" data-panel="search">
                    <i class="fas fa-search"></i>
                    <span data-i18n="search.title">Adresssuche</span>
                </button>
                <button class="menu-item" data-panel="topo-source">
                    <i class="fas fa-mountain"></i>
                    <span data-i18n="topo.source">Topografie-Quelle</span>
                </button>
                <button class="menu-item" data-panel="pv-areas">
                    <i class="fas fa-solar-panel"></i>
                    <span data-i18n="menu.pvAreas">PV-Flächen</span>
                </button>
                <button class="menu-item" data-panel="observation-points">
                    <i class="fas fa-eye"></i>
                    <span data-i18n="menu.observationPoints">Betrachtungspunkte</span>
                </button>
                <button class="menu-item" data-panel="excluded-areas">
                    <i class="fas fa-ban"></i>
                    <span data-i18n="menu.excludedAreas">Ausschlussbereiche</span>
                </button>
                <button class="menu-item" data-panel="obstacles">
                    <i class="fas fa-building"></i>
                    <span data-i18n="menu.obstacles">Hindernisse</span>
                </button>
            </div>
            
            <!-- Content Panels -->
            
            <!-- Default Navigation Hint -->
            <div class="content-panel" id="default-hint">
                <div class="text-center p-4">
                    <i class="fas fa-hand-pointer fa-3x text-muted mb-3"></i>
                    <h6 class="text-muted">Navigation</h6>
                    <p class="small text-muted">
                        Verwenden Sie die Maus, um die Karte zu bewegen und zu zoomen.
                    </p>
                    <hr class="my-3">
                    <p class="small text-muted">
                        <span data-i18n="menu.selectFunction">Wählen Sie eine Funktion aus dem Menü, um zu beginnen.</span>
                    </p>
                </div>
            </div>
            
            <!-- Search Panel -->
            <div class="content-panel" id="panel-search">
                <h6 class="menu-header" data-i18n="search.title">Adresssuche</h6>
                <button class="back-button" onclick="backToMenu()">
                    <i class="fas fa-chevron-left"></i>
                    <span class="button-text"><span data-i18n="menu.backToMain">Zurück zum Hauptmenü</span></span>
                </button>
                <div class="search-box p-0">
                    <input type="text" class="search-input" id="address-search" placeholder="Adresse oder Koordinaten eingeben...">
                    <button class="btn btn-primary btn-sm w-100 mt-2" onclick="SearchManager.search()">
                        <i class="fas fa-search"></i> <span data-i18n="search.button">Suchen</span>
                    </button>
                    <div class="mt-3 small text-muted">
                        <p class="mb-1"><strong><span data-i18n="search.tip">Tipp:</span></strong> <span data-i18n="search.tipCoordinates">Auch Koordinaten möglich</span></p>
                        <p class="mb-1"><span data-i18n="search.formatExample">Format: 48.1351, 11.5820 oder 48.1351 11.5820</span></p>
                        <p class="mb-0 text-black-50" style="font-size: 0.85rem;"><span data-i18n="search.exampleAddress">z.B. Marienplatz, München</span></p>
                    </div>
                </div>
            </div>

            <!-- Topography Source Panel -->
            <div class="content-panel" id="panel-topo-source">
                <h6 class="menu-header" data-i18n="topo.title">Höhendaten-Quelle wählen</h6>
                <button class="back-button" onclick="backToMenu()">
                    <i class="fas fa-chevron-left"></i>
                    <span class="button-text"><span data-i18n="menu.backToMain">Zurück zum Hauptmenü</span></span>
                </button>

                <div class="topo-panel-content">
                    <!-- Introduction Text -->
                    <div class="alert alert-light border mb-3">
                        <p class="mb-0 small" data-i18n="topo.intro">
                            Wählen Sie eine Quelle für die Geländehöhendaten. Falls Sie keine eigenen Höhendaten haben, verwenden Sie einfach Google.
                        </p>
                    </div>

                    <!-- Options Container (initially shown) -->
                    <div id="topo-options-container">
                        <!-- Google API Option -->
                        <div class="topo-option-card" onclick="selectTopoSource('google')">
                            <div class="topo-option-title" data-i18n="topo.googleApi">Google Elevation API</div>
                            <div class="topo-option-desc" data-i18n="topo.googleApiDesc">Automatische Höhenbestimmung weltweit verfügbar</div>
                        </div>

                        <!-- Custom Data Option -->
                        <div class="topo-option-card" onclick="selectTopoSource('custom')">
                            <div class="topo-option-title" data-i18n="topo.customData">Eigene präzise Höhendaten</div>
                            <div class="topo-option-desc" data-i18n="topo.customDataDesc">Für beste Ergebnisse: DGM1, LiDAR oder eigene Vermessungsdaten</div>
                        </div>

                        <!-- Best Practice Tip -->
                        <div class="alert alert-info small mb-0">
                            <strong>Tipp:</strong> <span data-i18n="topo.bestPractice">Beste Ergebnisse mit DGM1 (1m Raster) oder vergleichbaren hochauflösenden Geländemodellen</span>
                        </div>
                    </div>

                    <!-- Custom Data Upload Section (initially hidden) -->
                    <div id="custom-data-upload" style="display: none;">
                        <h6 class="text-secondary mb-3">
                            <i class="fas fa-file-upload me-2"></i>
                            <span data-i18n="topo.uploadFile">Datei hochladen</span>
                        </h6>

                        <!-- Drag & Drop Area -->
                        <div id="topo-drop-zone" class="topo-drop-zone">
                            <input type="file" id="topo-file-input" accept=".tif,.tiff,.xyz,.txt" style="display: none;" onchange="handleTopoFileUpload(event)">
                            <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-muted"></i>
                            <p class="mb-2" data-i18n="topo.dragDrop">Datei hier ablegen oder klicken zum Auswählen</p>
                            <p class="small text-muted mb-0">GeoTIFF, XYZ</p>
                        </div>

                        <!-- File Requirements -->
                        <div class="mt-3">
                            <p class="small mb-2"><strong><i class="fas fa-info-circle me-1"></i> Anforderungen:</strong></p>
                            <ul class="small mb-2 ps-3">
                                <li data-i18n="topo.fileFormats">Unterstützte Formate: GeoTIFF (.tif, .tiff), XYZ (.xyz, .txt)</li>
                                <li data-i18n="topo.coordinateSystem">Koordinatensystem: EPSG:4326 (WGS84) empfohlen</li>
                                <li data-i18n="topo.minResolution">Unterstützte Auflösung: 1 bis 50 Meter Gitterweite</li>
                            </ul>
                        </div>

                        <div class="alert alert-warning small mb-3">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            <span data-i18n="topo.warning">Hinweis: Objekte können nur im Bereich der hochgeladenen Höhendaten platziert werden.</span>
                        </div>

                        <button class="btn btn-secondary btn-sm w-100" onclick="cancelCustomDataUpload()">
                            <i class="fas fa-arrow-left me-1"></i>
                            <span data-i18n="common.cancel">Zurück</span>
                        </button>
                    </div>

                    <!-- Current Source Display -->
                    <div id="current-topo-source" style="display: none;">
                        <div class="alert alert-success">
                            <p class="mb-2">
                                <strong><i class="fas fa-check-circle me-1"></i> <span data-i18n="topo.success">Höhendaten erfolgreich geladen</span></strong>
                            </p>
                            <div id="current-source-info" class="small"></div>
                        </div>
                        <button class="btn btn-outline-primary btn-sm w-100" onclick="changeTopoSource()">
                            <i class="fas fa-sync-alt me-1"></i>
                            <span data-i18n="topo.changeSource">Quelle ändern</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- PV Areas Panel -->
            <div class="content-panel" id="panel-pv-areas">
                <h6 class="menu-header" data-i18n="menu.pvAreas">PV-Flächen</h6>
                <button class="back-button" onclick="backToMenu()">
                    <i class="fas fa-chevron-left"></i>
                    <span class="button-text"><span data-i18n="menu.backToMain">Zurück zum Hauptmenü</span></span>
                </button>
                <button class="btn btn-create" onclick="showPVTypeModal()">
                    <i class="fas fa-plus"></i>
                    <span><span data-i18n="menu.newPV">Neue PV-Fläche erstellen</span></span>
                </button>
                
                <div class="scrollable-wrapper">
                    <h6 style="margin: 20px 5px 15px 5px;"><span data-i18n="pvList.existing">Vorhandene PV-Flächen:</span></h6>
                    <div class="element-list" id="pv-list">
                        <p class="text-muted small"><span data-i18n="pvList.empty">Keine PV-Flächen vorhanden</span></p>
                    </div>
                    <div class="text-muted small mt-2" style="padding: 0 5px 20px 5px;">
                        <i class="fas fa-info-circle"></i> 
                        <em>Tipp: Ziehen Sie am <i class="fas fa-grip-vertical"></i> Symbol, um die Reihenfolge zu ändern. Die Nummerierung (PV1, PV2, ...) wird automatisch angepasst.</em>
                    </div>
                </div>
            </div>
            
            <!-- PV Arrays Panel -->
            <!-- Observation Points Panel -->
            <div class="content-panel" id="panel-observation-points">
                <h6 class="menu-header" data-i18n="menu.observationPoints">Betrachtungspunkte</h6>
                <button class="back-button" onclick="backToMenu()">
                    <i class="fas fa-chevron-left"></i>
                    <span class="button-text"><span data-i18n="menu.backToMain">Zurück zum Hauptmenü</span></span>
                </button>
                <button class="btn btn-create" onclick="startDrawingOP()">
                    <i class="fas fa-plus"></i>
                    <span>Neuen Betrachtungspunkt setzen</span>
                </button>
                
                <div class="scrollable-wrapper">
                    <div style="padding: 20px 5px 0 5px;">
                        <div class="mb-3">
                            <label class="form-label small">Beobachterhöhe (m):</label>
                            <input type="number" class="form-control form-control-sm" id="op-height-observer" value="1.5" step="0.1">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">Objekthöhe (m):</label>
                            <input type="number" class="form-control form-control-sm" id="op-height-object" value="10" step="0.1">
                        </div>
                    </div>
                    
                    <h6 style="margin: 20px 5px 15px 5px;">Vorhandene Betrachtungspunkte:</h6>
                    <div class="element-list" id="op-list">
                        <p class="text-muted small">Keine Betrachtungspunkte vorhanden</p>
                    </div>
                </div>
            </div>
            
            <!-- Excluded Areas Panel -->
            <div class="content-panel" id="panel-excluded-areas">
                <h6 class="menu-header" data-i18n="menu.excludedAreas">Ausschlussbereiche</h6>
                <button class="back-button" onclick="backToMenu()">
                    <i class="fas fa-chevron-left"></i>
                    <span class="button-text"><span data-i18n="menu.backToMain">Zurück zum Hauptmenü</span></span>
                </button>
                <button class="btn btn-create" onclick="startDrawingExcluded()">
                    <i class="fas fa-plus"></i>
                    <span>Neue Excluded Area zeichnen</span>
                </button>
                
                <h6>Vorhandene Excluded Areas:</h6>
                <div class="element-list" id="excluded-list">
                    <p class="text-muted small">Keine Excluded Areas vorhanden</p>
                </div>
            </div>
            
            <!-- Obstacles Panel -->
            <div class="content-panel" id="panel-obstacles">
                <h6 class="menu-header" data-i18n="menu.obstacles">Hindernisse</h6>
                <button class="back-button" onclick="backToMenu()">
                    <i class="fas fa-chevron-left"></i>
                    <span class="button-text"><span data-i18n="menu.backToMain">Zurück zum Hauptmenü</span></span>
                </button>
                <button class="btn btn-create" onclick="startDrawingObstacle()">
                    <i class="fas fa-plus"></i>
                    <span>Neues Hindernis zeichnen</span>
                </button>
                
                <h6>Vorhandene Hindernisse:</h6>
                <div class="element-list" id="obstacle-list">
                    <p class="text-muted small">Keine Hindernisse vorhanden</p>
                </div>
            </div>
        </aside>
        
        <!-- Map Container -->
        <div class="map-container">
            <div id="map"></div>
            <!-- Coordinate Display -->
            <div class="coordinate-display" id="coordinateDisplay">
                <div>
                    <span class="coord-label" data-i18n="coords.latitude">Lat</span>:
                    <span class="coord-value" id="latDisplay">-</span>
                </div>
                <div>
                    <span class="coord-label" data-i18n="coords.longitude">Lng</span>:
                    <span class="coord-value" id="lngDisplay">-</span>
                </div>
                <div id="elevationDisplay" style="display: none;">
                    <span class="coord-label" data-i18n="coords.elevationShort">Höhe</span>:
                    <span class="coord-value" id="elevDisplay">-</span> m
                </div>
            </div>
        </div>
        
        <!-- Corner Details Panel (Right Sidebar) -->
        <div id="cornerDetailsPanel" class="corner-details-panel">
            <div class="panel-header-wrapper">
                <h6 class="menu-header" id="cornerDetailsHeader" data-i18n="corner.title">Eckpunkte & Parameter</h6>
            </div>
            <div class="panel-body">
                <div id="cornerDetailsContent">
                    <!-- Content will be dynamically inserted here -->
                </div>
            </div>
            <div class="panel-footer">
                <button type="button" class="btn btn-secondary w-100" onclick="CornerDetailsManager.close()">
                    <i class="bi bi-x-lg me-2"></i><span data-i18n="common.close">Schließen</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="modal-container">
        <!-- PV Type Selection Modal -->
        <div class="modal fade" id="pvTypeModal" tabindex="-1" aria-labelledby="pvTypeModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="pvTypeModalLabel"><span data-i18n="pvType.select">PV-Anlagentyp auswählen</span></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary text-start p-3" onclick="selectPVType('roof-parallel')">
                                <i class="fas fa-home me-2"></i>
                                <strong>Dachanlage mit dachparallelen Modulen</strong>
                                <br>
                                <small class="text-muted"><span data-i18n="pvType.roofParallelDesc">Module parallel zur Dachfläche montiert</span></small>
                            </button>
                            <button class="btn btn-outline-primary text-start p-3" onclick="selectPVType('roof-mounted')">
                                <i class="fas fa-solar-panel me-2"></i>
                                <strong><span data-i18n="pvType.roofMountedTitle">Dachanlage mit aufgeständerten Modulen</span></strong>
                                <br>
                                <small class="text-muted">Module mit Neigung auf Flachdach</small>
                            </button>
                            <button class="btn btn-outline-primary text-start p-3" onclick="selectPVType('facade')">
                                <i class="fas fa-building me-2"></i>
                                <strong>Fassadenanlage / Vertikale PV</strong>
                                <br>
                                <small class="text-muted">Vertikale Module an Fassade, Zaun oder freistehend</small>
                            </button>
                            <button class="btn btn-outline-primary text-start p-3" onclick="selectPVType('field')">
                                <i class="fas fa-seedling me-2"></i>
                                <strong><span data-i18n="pvType.fieldTitle">Freiflächenanlage</span></strong>
                                <br>
                                <small class="text-muted">Bodengebundene PV-Anlage</small>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Drawing Instructions Modal -->
        <div class="modal fade" id="drawingInstructionsModal" tabindex="-1" aria-labelledby="drawingInstructionsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="drawingInstructionsModalLabel">Zeichenanleitung</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="drawingInstructionsContent">
                        <!-- Content will be filled dynamically -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="startDrawingAfterInstructions()">
                            <i class="fas fa-pencil-alt"></i> Zeichnen starten
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- General Message Modal -->
        <div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="messageModalLabel">Hinweis</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="messageModalBody">
                        <!-- Content will be filled dynamically -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Module Type Manager Modal -->
        <div class="modal fade" id="moduleTypeModal" tabindex="-1" aria-labelledby="moduleTypeModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="moduleTypeModalLabel">Modultypen verwalten</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <button class="btn btn-sm btn-primary" onclick="ModuleTypeManager.addNew()">
                                <i class="bi bi-plus-circle"></i> Neuer Modultyp
                            </button>
                        </div>
                        <div id="moduleTypesList">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><span data-i18n="common.close">Schließen</span></button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Add/Edit Module Type Modal -->
        <div class="modal fade" id="moduleTypeFormModal" tabindex="-1" aria-labelledby="moduleTypeFormModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="moduleTypeFormModalLabel">Neuer Modultyp</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="moduleTypeForm">
                            <div class="mb-3">
                                <label for="moduleTypeName" class="form-label">Name</label>
                                <input type="text" class="form-control" id="moduleTypeName" required>
                            </div>
                            <div class="mb-3">
                                <label for="moduleTypeBeamSpread" class="form-label">
                                    <span data-i18n="module.beamSpread">Bündelaufweitung (°)</span>
                                    <i class="bi bi-info-circle text-muted ms-1" 
                                       data-bs-toggle="tooltip" 
                                       data-bs-placement="top"
                                       title="Die Bündelaufweitung definiert den Streuwinkel der Reflexion">
                                    </i>
                                </label>
                                <input type="number" class="form-control" id="moduleTypeBeamSpread" 
                                       min="0" max="10" step="0.1" value="0.5" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">
                                    Reflexionsprofil
                                    <i class="bi bi-info-circle text-muted ms-1" 
                                       data-bs-toggle="tooltip" 
                                       data-bs-placement="top"
                                       title="Leuchtdichte der Reflexion bei 100.000 lx Bestrahlungsstärke auf der Fläche für verschiedene Einfallswinkel">
                                    </i>
                                </label>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Einfallswinkel (°)</th>
                                                <th>Leuchtdichte (cd/m²)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>0°</td>
                                                <td><input type="number" class="form-control form-control-sm" id="reflection0" min="0" step="any" value="70000"></td>
                                            </tr>
                                            <tr>
                                                <td>10°</td>
                                                <td><input type="number" class="form-control form-control-sm" id="reflection10" min="0" step="any" value="70000"></td>
                                            </tr>
                                            <tr>
                                                <td>20°</td>
                                                <td><input type="number" class="form-control form-control-sm" id="reflection20" min="0" step="any" value="71000"></td>
                                            </tr>
                                            <tr>
                                                <td>30°</td>
                                                <td><input type="number" class="form-control form-control-sm" id="reflection30" min="0" step="any" value="79000"></td>
                                            </tr>
                                            <tr>
                                                <td>40°</td>
                                                <td><input type="number" class="form-control form-control-sm" id="reflection40" min="0" step="any" value="120000"></td>
                                            </tr>
                                            <tr>
                                                <td>50°</td>
                                                <td><input type="number" class="form-control form-control-sm" id="reflection50" min="0" step="any" value="280000"></td>
                                            </tr>
                                            <tr>
                                                <td>60°</td>
                                                <td><input type="number" class="form-control form-control-sm" id="reflection60" min="0" step="any" value="930000"></td>
                                            </tr>
                                            <tr>
                                                <td>70°</td>
                                                <td><input type="number" class="form-control form-control-sm" id="reflection70" min="0" step="any" value="3900000"></td>
                                            </tr>
                                            <tr>
                                                <td>80°</td>
                                                <td><input type="number" class="form-control form-control-sm" id="reflection80" min="0" step="any" value="16134855"></td>
                                            </tr>
                                            <tr>
                                                <td>90°</td>
                                                <td><input type="number" class="form-control form-control-sm" id="reflection90" min="0" step="any" value="58377635"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                        <button type="button" class="btn btn-primary" onclick="ModuleTypeManager.save()">Speichern</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PV Area Delete Confirmation Modal -->
        <div class="modal fade" id="pvAreaDeleteModal" tabindex="-1" aria-labelledby="pvAreaDeleteModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="pvAreaDeleteModalLabel">
                            <i class="bi bi-exclamation-triangle me-2"></i><span data-i18n="delete.confirmPV">PV-Fläche löschen</span>
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p id="pvAreaDeleteMessage"><span data-i18n="delete.confirmPV">Möchten Sie diese PV-Fläche wirklich löschen?</span></p>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Hinweis:</strong> Alle zugehörigen Daten und Einstellungen dieser PV-Fläche werden unwiderruflich gelöscht.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                        <button type="button" class="btn btn-danger" id="confirmDeletePVArea" onclick="PVListRenderer.confirmDelete()">
                            <i class="bi bi-trash me-1"></i><span data-i18n="common.delete">Löschen</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Module Type Delete Confirmation Modal -->
        <div class="modal fade" id="moduleTypeDeleteModal" tabindex="-1" aria-labelledby="moduleTypeDeleteModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="moduleTypeDeleteModalLabel">
                            <i class="bi bi-exclamation-triangle me-2"></i><span data-i18n="module.deleteTitle">Modultyp löschen</span>
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p id="moduleTypeDeleteMessage">Möchten Sie diesen Modultyp wirklich löschen?</p>
                        <div class="alert alert-warning d-none" id="moduleTypeInUseWarning">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Hinweis:</strong> Dieser Modultyp wird aktuell von PV-Flächen verwendet und kann nicht gelöscht werden. 
                            Bitte ändern Sie zuerst den Modultyp der betroffenen PV-Flächen.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteModuleType" onclick="ModuleTypeManager.confirmDelete()">
                            <i class="bi bi-trash me-1"></i><span data-i18n="common.delete">Löschen</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Import Modular JavaScript before Google Maps -->
    <script type="module">
        // Import modules
        import { GeometryUtils } from '/static/js/utils/geometry.js';
        import { UIManager } from '/static/js/ui/ui-manager.js';
        import { StateManager } from '/static/js/core/state-manager.js';
        import { PVListRenderer } from '/static/js/ui/pv-list-renderer.js';
        import { MapManager } from '/static/js/core/map-manager.js';
        import { DrawingManager } from '/static/js/pv-areas/drawing-manager.js';
        import { ModuleTypeManager } from '/static/js/ui/module-type-manager.js';
        import { CornerDetailsManager } from '/static/js/ui/corner-details-manager.js';
        import { SearchManager } from '/static/js/ui/search-manager.js';
        import { TopographySourceManager } from '/static/js/core/topography-source-manager.js';

        // Make modules available globally for backward compatibility
        window.GeometryUtils = GeometryUtils;
        window.UIManager = UIManager;
        window.StateManager = StateManager;
        window.MapManager = MapManager;
        window.DrawingManager = DrawingManager;
        window.ModuleTypeManager = ModuleTypeManager;
        window.SearchManager = SearchManager;
        window.TopographySourceManager = TopographySourceManager;

        // Expose individual geometry functions
        window.rotationMatrix = GeometryUtils.rotationMatrix.bind(GeometryUtils);
        window.matrixVectorMultiply = GeometryUtils.matrixVectorMultiply.bind(GeometryUtils);
        window.vectorAngle = GeometryUtils.vectorAngle.bind(GeometryUtils);
        window.calculateEffectiveValues = GeometryUtils.calculateEffectiveValues.bind(GeometryUtils);
        window.calculateBestFitPlane = GeometryUtils.calculateBestFitPlane.bind(GeometryUtils);
        window.getMidpoint = GeometryUtils.getMidpoint.bind(GeometryUtils);
        window.constrainToLine = GeometryUtils.constrainToLine.bind(GeometryUtils);
        window.calculateRectangle = GeometryUtils.calculateRectangle.bind(GeometryUtils);
        window.calculatePerpendicularDistance = GeometryUtils.calculatePerpendicularDistance.bind(GeometryUtils);
        
        // Expose UI functions
        window.showMessage = UIManager.showMessage.bind(UIManager);
        window.showPanel = UIManager.showPanel.bind(UIManager);
        window.backToMenu = UIManager.backToMenu.bind(UIManager);
        window.togglePVDetails = UIManager.togglePVDetails.bind(UIManager);
        
        // Initialize PV List Renderer
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize StateManager to load default module types
            await StateManager.initialize();
            
            PVListRenderer.initialize();
            
            // Load Google Maps API after modules are ready
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap&libraries=drawing,geometry,places`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        });
        
        // Subscribe to state changes to update UI
        StateManager.subscribe((type, data) => {
            // State changed: type, data
        });
    </script>
    
    <!-- Temporary: Include the rest of the original code until we modularize it -->
    <script>
        // Global variables (these will be gradually moved to modules)
        let map;
        let drawingManager;
        let tempPolyline = null;
        let tempPolygon = null;
        let rectanglePoints = [];
        let roofParallelEditor = null;
        
        // Initialize when page loads using MapManager
        async function initMap() {
            // Initialize map using MapManager
            map = await MapManager.initialize('map');
            drawingManager = MapManager.getDrawingManager();
            
            // Set up event listeners
            MapManager.on('polygonComplete', (polygon) => {
                // Handle polygon completion
            });
            
            MapManager.on('markerComplete', (marker) => {
                // Handle marker completion
            });
            
            // Add mouse coordinate tracking
            // Function to update coordinates
            function updateCoordinates(event) {
                if (event && event.latLng) {
                    const lat = event.latLng.lat();
                    const lng = event.latLng.lng();
                    
                    // Update coordinate display
                    document.getElementById('latDisplay').textContent = lat.toFixed(6);
                    document.getElementById('lngDisplay').textContent = lng.toFixed(6);
                }
            }
            
            // Function to clear coordinates
            function clearCoordinates() {
                document.getElementById('latDisplay').textContent = '-';
                document.getElementById('lngDisplay').textContent = '-';
                document.getElementById('elevDisplay').textContent = '-';
            }

            // Update elevation display based on topography source
            function updateElevationDisplay(lat, lng) {
                const topoInfo = TopographySourceManager.getSourceInfo();
                const elevDisplay = document.getElementById('elevationDisplay');
                const elevValue = document.getElementById('elevDisplay');

                if (!elevDisplay || !elevValue) return;

                // Only show elevation if custom data is loaded AND has actual data
                if (topoInfo &&
                    topoInfo.type === 'custom' &&
                    topoInfo.isConfigured &&
                    topoInfo.customFile &&
                    topoInfo.bounds) {
                    // Show elevation row
                    elevDisplay.style.display = 'block';

                    // Get elevation from custom data
                    const elevation = TopographySourceManager.interpolateElevation(lat, lng);

                    if (elevation !== null && elevation !== undefined && elevation !== 0) {
                        elevValue.textContent = elevation.toFixed(1);
                    } else {
                        elevValue.textContent = '-';
                    }
                } else {
                    // Hide elevation row for Google API or no source
                    elevDisplay.style.display = 'none';
                }
            }
            
            // Track mouse on map
            google.maps.event.addListener(map, 'mousemove', updateCoordinates);
            
            // Also track when drawing (DrawingManager captures mouse events)
            google.maps.event.addListener(drawingManager, 'mousemove', updateCoordinates);
            
            // Track during overlay complete events
            google.maps.event.addListener(drawingManager, 'overlaycomplete', function(event) {
                // Re-attach listener after drawing completes
                setTimeout(() => {
                    google.maps.event.addListener(map, 'mousemove', updateCoordinates);
                }, 100);
            });
            
            // Hide coordinates when mouse leaves map
            google.maps.event.addListener(map, 'mouseout', clearCoordinates);
            
            // Alternative approach: Use DOM mouse events with overlay projection
            const mapDiv = document.getElementById('map');
            let lastUpdateTime = 0;
            
            mapDiv.addEventListener('mousemove', function(e) {
                // Throttle updates to 60fps
                const now = Date.now();
                if (now - lastUpdateTime < 16) return;
                lastUpdateTime = now;
                
                // Use OverlayView to get accurate projection
                const overlay = new google.maps.OverlayView();
                overlay.draw = function() {};
                overlay.setMap(map);
                
                const projection = overlay.getProjection();
                if (projection) {
                    // Get mouse position relative to map container
                    const rect = mapDiv.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    // Convert pixel coordinates to lat/lng
                    const point = new google.maps.Point(x, y);
                    const latLng = projection.fromContainerPixelToLatLng(point);
                    
                    if (latLng) {
                        document.getElementById('latDisplay').textContent = latLng.lat().toFixed(6);
                        document.getElementById('lngDisplay').textContent = latLng.lng().toFixed(6);

                        // Update elevation if custom data is loaded
                        updateElevationDisplay(latLng.lat(), latLng.lng());
                    }
                    
                    // Clean up overlay
                    overlay.setMap(null);
                }
            });
            
            mapDiv.addEventListener('mouseleave', clearCoordinates);

            // Initialize UI
            initializeUI();

            // Initialize Search Manager
            SearchManager.initialize();

            // Initialize Topography Source Manager
            TopographySourceManager.initialize();

            // Add global click handler for locked menu items
            document.addEventListener('click', (e) => {
                const menuItem = e.target.closest('.menu-item');
                if (menuItem && menuItem.getAttribute('data-locked') === 'true') {
                    e.preventDefault();
                    e.stopPropagation();
                    const t = (key, params) => window.i18n ? window.i18n.t(key, params) : key;
                    UIManager.showNotification(t('topo.requiredMessage'), 'warning');
                }
            }, true); // Use capture phase to catch before other handlers

            // Make map globally available for backward compatibility
            window.map = map;
            window.drawingManager = drawingManager;
        }
        
        // Initialize UI using the UIManager module
        function initializeUI() {
            UIManager.initializeUI();
        }
        
        // Show PV type selection modal
        function showPVTypeModal() {
            const modal = new bootstrap.Modal(document.getElementById('pvTypeModal'));
            modal.show();
        }
        
        // Handle PV type selection and show instructions
        function selectPVType(type) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('pvTypeModal'));
            modal.hide();

            // Store selected type
            window.selectedPVType = type;

            // i18n helper
            const t = (key, params) => window.i18n ? window.i18n.t(key, params) : key;

            // Show appropriate instructions
            const instructionsContent = document.getElementById('drawingInstructionsContent');

            switch(type) {
                case 'roof-parallel':
                    instructionsContent.innerHTML = `
                        <div class="mb-3">
                            <h6 class="text-primary"><i class="fas fa-info-circle"></i> ${t('draw.roofParallel.title')}</h6>
                        </div>
                        <div class="alert alert-primary">
                            <p class="mb-2"><strong>${t('draw.howToDraw')}</strong></p>
                            <ol class="mb-0">
                                <li>${t('draw.roofParallel.step1')}</li>
                                <li>${t('draw.roofParallel.step2')}</li>
                                <li>${t('draw.roofParallel.step3')}</li>
                            </ol>
                        </div>
                        <p class="small text-muted mb-0">
                            <i class="fas fa-keyboard"></i> ${t('draw.escToCancel')}<br>
                            <i class="fas fa-edit"></i> ${t('draw.roofParallel.tip1')}<br>
                            <i class="fas fa-ban"></i> ${t('draw.roofParallel.tip2')}
                        </p>
                    `;
                    break;
                case 'roof-mounted':
                    instructionsContent.innerHTML = `
                        <div class="mb-3">
                            <h6 class="text-primary"><i class="fas fa-solar-panel"></i> ${t('draw.roofMounted.title')}</h6>
                        </div>
                        <div class="alert alert-primary">
                            <p class="mb-2"><strong>${t('draw.howToDraw')}</strong></p>
                            <ul class="mb-0">
                                <li>${t('draw.roofMounted.step1')}</li>
                                <li>${t('draw.roofMounted.step2')}</li>
                            </ul>
                        </div>
                        <p class="small text-muted mb-0">
                            <i class="fas fa-keyboard"></i> ${t('draw.escToCancel')}
                        </p>
                    `;
                    break;
                case 'field':
                    instructionsContent.innerHTML = `
                        <div class="mb-3">
                            <h6 class="text-primary"><i class="fas fa-seedling"></i> ${t('draw.field.title')}</h6>
                        </div>
                        <div class="alert alert-primary">
                            <p class="mb-2"><strong>${t('draw.howToDraw')}</strong></p>
                            <ul class="mb-0">
                                <li>${t('draw.field.step1')}</li>
                                <li>${t('draw.field.step2')}</li>
                                <li>${t('draw.field.step3')}</li>
                            </ul>
                        </div>
                        <p class="small text-muted mb-0">
                            <i class="fas fa-keyboard"></i> ${t('draw.escToCancel')}
                        </p>
                    `;
                    break;
                case 'facade':
                    instructionsContent.innerHTML = `
                        <div class="mb-3">
                            <h6 class="text-primary"><i class="fas fa-building"></i> ${t('draw.facade.title')}</h6>
                        </div>
                        <div class="alert alert-primary">
                            <p class="mb-2"><strong>${t('draw.howToDrawVertical')}</strong></p>
                            <ul class="mb-0">
                                <li>${t('draw.facade.step1')}</li>
                                <li>${t('draw.facade.step2')}</li>
                                <li>${t('draw.facade.step3')}</li>
                            </ul>
                        </div>
                        <div class="alert alert-primary">
                            <small><i class="fas fa-lightbulb"></i> <strong>${t('draw.tip')}</strong> ${t('draw.facade.tip')}</small>
                        </div>
                        <p class="small text-muted mb-0">
                            <i class="fas fa-keyboard"></i> ${t('draw.escToCancel')}
                        </p>
                    `;
                    break;
                case 'ground':
                    instructionsContent.innerHTML = `
                        <div class="mb-3">
                            <h6 class="text-primary"><i class="fas fa-seedling"></i> ${t('draw.field.title')}</h6>
                        </div>
                        <div class="alert alert-primary">
                            <p class="mb-2"><strong>${t('draw.howToDraw')}</strong></p>
                            <ul class="mb-0">
                                <li>${t('draw.field.stepAlt1')}</li>
                                <li>${t('draw.field.step2')}</li>
                            </ul>
                        </div>
                        <p class="small text-muted mb-0">
                            <i class="fas fa-keyboard"></i> ${t('draw.escToCancel')}
                        </p>
                    `;
                    break;
            }
            
            // Show instructions modal
            const instructionsModal = new bootstrap.Modal(document.getElementById('drawingInstructionsModal'));
            instructionsModal.show();
        }
        
        // Start drawing after instructions
        function startDrawingAfterInstructions() {
            const type = window.selectedPVType;
            
            switch(type) {
                case 'roof-parallel':
                    // 3-click parallelogram for roof-parallel
                    DrawingManager.startDrawing(DrawingManager.TYPES.ROOF_PARALLEL, 'roof-parallel');
                    break;
                case 'facade':
                    // Two-point line drawing for facades
                    DrawingManager.startDrawing(DrawingManager.TYPES.FACADE, 'facade');
                    break;
                case 'roof-mounted':
                    // Polygon drawing for roof-mounted
                    DrawingManager.startDrawing(DrawingManager.TYPES.FREEFORM, 'roof-mounted');
                    break;
                case 'field':
                    // Polygon drawing for field installations (like roof-mounted)
                    DrawingManager.startDrawing(DrawingManager.TYPES.FREEFORM, 'field');
                    break;
            }
        }
        
        // Make functions globally available
        window.selectPVType = selectPVType;
        window.startDrawingAfterInstructions = startDrawingAfterInstructions;
        
        function startDrawingOP() {
            UIManager.showMessage('Betrachtungspunkt zeichnen - In Entwicklung...', 'Betrachtungspunkt');
        }
        
        function startDrawingExcluded() {
            UIManager.showMessage('Excluded Area zeichnen - In Entwicklung...', 'Excluded Area');
        }
        
        function startDrawingObstacle() {
            UIManager.showMessage('Hindernis zeichnen - In Entwicklung...', 'Hindernis');
        }
        
        function searchAddress() {
            const input = document.getElementById('address-search').value;
            if (input) {
                UIManager.showLoading(true, 'Suche Adresse...');
                setTimeout(() => {
                    UIManager.showLoading(false);
                    UIManager.showMessage(`Adresssuche für "${input}" - In Entwicklung...`, 'Adresssuche');
                }, 1000);
            } else {
                UIManager.showMessage('Bitte geben Sie eine Adresse ein.', 'Adresssuche');
            }
        }

        // Topography Source Functions
        function selectTopoSource(sourceType) {
            const t = (key, params) => window.i18n ? window.i18n.t(key, params) : key;

            if (sourceType === 'google') {
                TopographySourceManager.selectGoogleAPI();
                showCurrentTopoSource();
                backToMenu();
            } else if (sourceType === 'custom') {
                // Hide options, show upload section
                document.getElementById('topo-options-container').style.display = 'none';
                document.getElementById('custom-data-upload').style.display = 'block';
                initializeDropZone();
            }
        }

        // Initialize drag & drop zone
        let dropZoneInitialized = false;

        function initializeDropZone() {
            if (dropZoneInitialized) return; // Only initialize once

            const dropZone = document.getElementById('topo-drop-zone');
            const fileInput = document.getElementById('topo-file-input');

            if (!dropZone || !fileInput) return;

            // Click to select file
            dropZone.addEventListener('click', () => {
                fileInput.click();
            });

            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            // Highlight drop zone when item is dragged over it
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.add('drag-over');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => {
                    dropZone.classList.remove('drag-over');
                }, false);
            });

            // Handle dropped files
            dropZone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;

                if (files.length > 0) {
                    fileInput.files = files;
                    handleTopoFileUpload({ target: { files: files } });
                }
            }, false);

            dropZoneInitialized = true;
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        async function handleTopoFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const t = (key, params) => window.i18n ? window.i18n.t(key, params) : key;

            const success = await TopographySourceManager.selectCustomData(file);

            if (success) {
                showCurrentTopoSource();
                backToMenu();
            }
        }

        function cancelCustomDataUpload() {
            document.getElementById('custom-data-upload').style.display = 'none';
            document.getElementById('topo-options-container').style.display = 'block';
            document.getElementById('topo-file-input').value = '';
        }

        function showCurrentTopoSource() {
            const t = (key, params) => window.i18n ? window.i18n.t(key, params) : key;
            const info = TopographySourceManager.getSourceInfo();

            const infoDiv = document.getElementById('current-source-info');

            if (info.type === 'google') {
                infoDiv.innerHTML = `<strong>${t('topo.googleApi')}</strong>`;
            } else if (info.type === 'custom') {
                const bounds = info.bounds;
                const resolution = info.resolution;
                infoDiv.innerHTML = `
                    <strong>${t('topo.fileSelected', {filename: info.customFile})}</strong><br>
                    ${t('topo.boundingBox')}: ${bounds.north.toFixed(4)}°N, ${bounds.south.toFixed(4)}°S, ${bounds.east.toFixed(4)}°E, ${bounds.west.toFixed(4)}°W<br>
                    ${t('topo.resolution')}: ${resolution.toFixed(1)}m
                `;
            }

            // Hide options and upload sections, show current source
            document.getElementById('topo-options-container').style.display = 'none';
            document.getElementById('custom-data-upload').style.display = 'none';
            document.getElementById('current-topo-source').style.display = 'block';
        }

        function changeTopoSource() {
            TopographySourceManager.reset();
            document.getElementById('current-topo-source').style.display = 'none';
            document.getElementById('custom-data-upload').style.display = 'none';
            document.getElementById('topo-options-container').style.display = 'block';
            document.getElementById('topo-file-input').value = '';
        }

        // Make functions globally available
        window.selectTopoSource = selectTopoSource;
        window.handleTopoFileUpload = handleTopoFileUpload;
        window.cancelCustomDataUpload = cancelCustomDataUpload;
        window.changeTopoSource = changeTopoSource;

        // Make initMap available globally for Google Maps callback
        window.initMap = initMap;
    </script>
    
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- GeoTIFF Library -->
    <script src="https://cdn.jsdelivr.net/npm/geotiff@2.0.7/dist-browser/geotiff.js"></script>

    <!-- i18n System -->
    <script src="/static/js/i18n/translations.js"></script>
    <script src="/static/js/ui/language-switcher.js"></script>

    <script>
        // Initialize language switcher on page load
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('languageSwitcherContainer');
            if (container && window.LanguageSwitcher) {
                container.innerHTML = window.LanguageSwitcher.render();
            }
        });
    </script>

    <!-- Google Maps API will be loaded dynamically after modules are ready -->
</body>
</html>